# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—à–∏–±–∫–∞ metricsCache.invalidateAllCache

## üêõ –ü–†–û–ë–õ–ï–ú–ê

```
‚ùå API error 500 for /admin/change-user-id:
TypeError: metricsCache.invalidateAllCache is not a function
```

**–ü—Ä–∏—á–∏–Ω–∞:** –í –∫–æ–¥–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã–∑—ã–≤–∞–ª–∞—Å—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è `metricsCache.invalidateAllCache()`

---

## üîç –ê–ù–ê–õ–ò–ó

### –ß—Ç–æ –±—ã–ª–æ –≤ –∫–æ–¥–µ:
```tsx
// /supabase/functions/server/index.tsx (—Å—Ç—Ä–æ–∫–∞ 7338)
await metricsCache.invalidateAllCache(); // ‚ùå –§—É–Ω–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
```

### –ß—Ç–æ –µ—Å—Ç—å –≤ user_metrics_cache.tsx:
```tsx
// –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
export async function getUserMetrics(userId: string)
export async function calculateAndCacheUserMetrics(userId: string)
export async function recalculateAllMetrics()
export async function invalidateUserMetrics(userId: string)    // ‚úÖ
export async function invalidatePageCache()                    // ‚úÖ

// ‚ùå invalidateAllCache() - –ù–ï–¢ –¢–ê–ö–û–ô –§–£–ù–ö–¶–ò–ò!
```

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

### –î–æ:
```tsx
// üîÑ STEP 7: Invalidate caches
await invalidateUsersCache();
await metricsCache.invalidateAllCache(); // ‚ùå –û–®–ò–ë–ö–ê
await invalidateRankCache();
```

### –ü–æ—Å–ª–µ:
```tsx
// üîÑ STEP 7: Invalidate caches
await invalidateUsersCache();
await metricsCache.invalidatePageCache(); // ‚úÖ –û—á–∏—â–∞–µ–º –∫—ç—à —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –º–µ—Ç—Ä–∏–∫
await invalidateRankCache();
```

---

## üìç –ì–î–ï –ë–´–õ–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–û

**–§–∞–π–ª:** `/supabase/functions/server/index.tsx`  
**–°—Ç—Ä–æ–∫–∞:** 7338  
**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /make-server-05aa3c8a/admin/change-user-id`

**–ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:**
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ ChangeUserId –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –Ω–∞ —ç—Ç–∞–ø–µ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞

---

## üîß –ß–¢–û –î–ï–õ–ê–ï–¢ invalidatePageCache()

```tsx
export async function invalidatePageCache() {
  // 1. –û—á–∏—â–∞–µ–º –∫—ç—à —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const pageKeys = await kv.getByPrefix('users_page:');
  for (const pageKey of pageKeys) {
    await kv.del(pageKey.key);
  }
  
  // 2. –û—á–∏—â–∞–µ–º –∫—ç—à —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  await kv.del('cache:all_users_list');
  
  console.log('üóëÔ∏è Invalidated all page caches and users list cache');
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- ‚úÖ –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üìä –ü–†–û–í–ï–†–ö–ê –î–†–£–ì–ò–• –í–´–ó–û–í–û–í

–ü—Ä–æ–≤–µ—Ä–∏–ª –≤—Å–µ –≤—ã–∑–æ–≤—ã `metricsCache.*` –≤ —Å–µ—Ä–≤–µ—Ä–µ:

```tsx
// ‚úÖ –í—Å–µ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –°–£–©–ï–°–¢–í–£–Æ–¢ –∏ —Ä–∞–±–æ—Ç–∞—é—Ç:
metricsCache.getUserMetrics(userId)           // 3 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
metricsCache.invalidatePageCache()            // 3 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–≤–∫–ª—é—á–∞—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ)
metricsCache.recalculateAllMetrics()          // 1 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

// ‚ùå –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢ (–±—ã–ª–æ 1 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ - –ò–°–ü–†–ê–í–õ–ï–ù–û):
metricsCache.invalidateAllCache()             // –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ invalidatePageCache()
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

**–¢–µ–ø–µ—Ä—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ ID —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏ –≤ –∫–æ–º–∞–Ω–¥–µ
3. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏ –≤ –∑–∞–∫–∞–∑–∞—Ö
4. ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
5. ‚úÖ **–û—á–∏—â–∞–µ—Ç –∫—ç—à —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é**
6. ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç

**–ë–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∏:**
```
‚ùå TypeError: metricsCache.invalidateAllCache is not a function
```

---

## üéØ –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨

1. –ê–¥–º–∏–Ω ‚Üí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
2. –í–∫–ª–∞–¥–∫–∞ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ID"
3. –°–µ–∫—Ü–∏—è "üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ID –∏ –ù–æ–º–µ—Ä–∞–º–∏"
4. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç "ChangeUserId"
5. –í–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ä—ã–π ID –∏ –Ω–æ–≤—ã–π ID
6. –ù–∞–∂–∞—Ç—å "–ò–∑–º–µ–Ω–∏—Ç—å ID"
7. ‚úÖ –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫!

---

## üìù –í–´–í–û–î–´

**–£—Ä–æ–∫:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –º–æ–¥—É–ª–µ!

**–ß—Ç–æ –±—ã–ª–æ:**
- –ì–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `invalidateAllCache()`
- –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–æ–¥

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –ó–∞–º–µ–Ω—ë–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã metricsCache
- ‚úÖ –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
