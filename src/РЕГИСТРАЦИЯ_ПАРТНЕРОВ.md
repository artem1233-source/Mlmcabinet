# Регистрация партнеров с автоматической выдачей ID

## Как зарегистрировать партнера

### Способ 1: Через форму регистрации (рекомендуется)

1. Перейдите на страницу `/register`
2. Заполните форму регистрации:
   - **ФИО** (обязательно)
   - **Email** (обязательно)
   - **Телефон** (опционально)
   - **Пароль** (минимум 6 символов, обязательно)
   - **Подтверждение пароля** (обязательно)
   - **Реферальный код спонсора** (опционально, например: P000001)

3. Нажмите кнопку **"Зарегистрироваться"**

4. После успешной регистрации вы получите:
   - ✅ Уникальный **ID партнера** в формате `P000001`, `P000002`, и т.д.
   - ✅ Реферальный код (совпадает с ID партнера)
   - ✅ Аккаунт в системе Supabase Auth
   - ✅ Запись в базе данных KV Store

5. Используйте **ID партнера** или **Email** для входа в личный кабинет

---

## Формат ID партнера

- Формат: `P` + 6-значное число с ведущими нулями
- Примеры: `P000001`, `P000002`, `P000123`
- ID генерируется автоматически при регистрации
- ID одновременно является **реферальным кодом**

---

## Реферальная система

### Как работает спонсорство

1. При регистрации новый партнер может указать **реферальный код спонсора**
2. Если код указан и валиден:
   - Новый партнер привязывается к спонсору
   - Спонсор добавляется в upline структуру (u0)
   - Новый партнер автоматически добавляется в команду спонсора
3. Если код не указан - партнер регистрируется без спонсора

### Структура upline

При регистрации со спонсором строится цепочка:
- **u0** - прямой спонсор
- **u1** - спонсор спонсора (u0 родителя)
- **u2** - u1 родителя
- **u3** - u2 родителя

---

## Вход в личный кабинет

### Способы входа:

1. **По ID партнера** (например: `P000001`)
2. **По Email** (например: `partner@example.com`)

### Страницы входа:

- `/login` - новая страница входа
- `/` - главная страница с EmailAuthRu (старая форма)

---

## Технические детали

### Серверный роут

```
POST https://${projectId}.supabase.co/functions/v1/make-server-05aa3c8a/register
```

### Тело запроса:

```json
{
  "name": "Иван Иванович Иванов",
  "email": "partner@example.com",
  "password": "secure-password",
  "phone": "+7 (999) 123-45-67",
  "sponsorRefCode": "P000001"
}
```

### Ответ при успехе:

```json
{
  "success": true,
  "partnerId": "P000002",
  "user": {
    "id": "P000002",
    "email": "partner@example.com",
    "имя": "Иван Иванович Иванов",
    "уровень": 1,
    "реф_код": "P000002",
    "спонсорId": "P000001",
    "upline": {
      "u0": "P000001",
      "u1": null,
      "u2": null,
      "u3": null
    },
    "баланс": 0,
    "команда": []
  },
  "message": "Регистрация успешна!"
}
```

---

## Хранение данных

### KV Store ключи:

1. `user:id:P000001` - основные данные партнера
2. `user:email:partner@example.com` - маппинг email → ID
3. `counter:partnerId` - счетчик для генерации ID

### Supabase Auth:

- Email + Password аутентификация
- `email_confirm: true` (автоподтверждение)
- user_metadata содержит имя партнера

---

## Примеры использования

### Регистрация без спонсора

```
ФИО: Иван Петров
Email: ivan@example.com
Пароль: mypassword123
Реферальный код: (оставить пустым)
```

Результат: партнер P000001 без upline структуры

### Регистрация со спонсором

```
ФИО: Мария Сидорова
Email: maria@example.com
Пароль: mypassword123
Реферальный код: P000001
```

Результат: партнер P000002 с upline.u0 = P000001

---

## Проверка работы

1. Зарегистрируйте тестового партнера на `/register`
2. Проверьте, что получили ID в формате P000001
3. Войдите в систему используя:
   - ID: `P000001`
   - Email: ваш email
   - Пароль: ваш пароль
4. Проверьте раздел "Профиль" - должен отображаться ваш ID и реферальный код

---

## Важно!

- ✅ ID генерируется автоматически и уникален
- ✅ ID одновременно является реферальным кодом
- ✅ Все новые партнеры начинают с уровня 1
- ✅ Спонсор опционален
- ✅ Email должен быть уникальным
- ✅ Пароль минимум 6 символов
- ✅ После регистрации автоматически создается аккаунт в Supabase Auth
