# 🔄 Как работает единая база данных

## 📊 СХЕМА АВТОРИЗАЦИИ:

```
┌─────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌───────────────┐           ┌───────────────┐
│  ВЕБ-САЙТ     │           │  TELEGRAM     │
│  (Browser)    │           │  MINI APP     │
└───────┬───────┘           └───────┬───────┘
        │                           │
        │                           │
        ▼                           ▼
┌────────────────────────────────────────────┐
│     Telegram Login Widget / WebApp SDK     │
│                                            │
│  Получает данные:                          │
│  • Telegram ID: 123456789                  │
│  • Имя: Артем Хачатрян                     │
│  • Username: @artem                        │
│  • Photo URL: ...                          │
└────────────────┬───────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────┐
│         СУPABASE EDGE FUNCTION              │
│         /telegram-auth роут                 │
│                                             │
│  1. Получает Telegram ID: 123456789         │
│  2. Ищет: user:tg:123456789                 │
│  3. Если НЕТ → создаёт нового пользователя  │
│  4. Если ЕСТЬ → возвращает существующего    │
└────────────────┬────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────┐
│          SUPABASE KV STORE                  │
│                                             │
│  Ключ: user:tg:123456789                    │
│  Значение: {                                │
│    id: "u_tg_123456789",                    │
│    telegramId: 123456789,                   │
│    имя: "Артем Хачатрян",                   │
│    username: "artem",                       │
│    баланс: 1500,                            │
│    уровень: 1,                              │
│    рефКод: "REF456789",                     │
│    ...                                      │
│  }                                          │
└─────────────────────────────────────────────┘
```

---

## ✅ ПОЧЕМУ ЭТО РАБОТАЕТ:

### Ключевой момент: **Telegram ID**

1. **Telegram ID уникален** для каждого пользователя
2. **Не меняется** никогда
3. **Одинаковый** при входе с сайта и через Mini App

### Пример:

```javascript
// Пользователь заходит ПЕРВЫЙ РАЗ через сайт:
Telegram ID: 123456789
→ Создаётся ключ: user:tg:123456789
→ Сохраняется пользователь

// Тот же пользователь заходит через Mini App:
Telegram ID: 123456789 (тот же!)
→ Ищет ключ: user:tg:123456789
→ Находит существующего пользователя!
→ Возвращает ЕГО данные

// Результат: ОДИН АККАУНТ! ✅
```

---

## 🔐 СЦЕНАРИИ ИСПОЛЬЗОВАНИЯ:

### Сценарий 1: Новый пользователь через сайт
```
1. Артем открывает https://mlm-partner-cabinet2.vercel.app
2. Нажимает "Log in with Telegram"
3. Подтверждает доступ
4. ✅ Создаётся аккаунт: user:tg:123456789
```

### Сценарий 2: Тот же пользователь через Mini App
```
1. Артем открывает https://t.me/h2enterbot/h2partner
2. Telegram автоматически передаёт ID: 123456789
3. ✅ Система находит: user:tg:123456789
4. ✅ Артем видит свой баланс и данные!
```

### Сценарий 3: Реферальная ссылка
```
1. Артем получает реф-код: REF456789
2. Отправляет другу ссылку:
   https://t.me/h2enterbot/h2partner?startapp=REF456789
3. Друг регистрируется с Telegram ID: 987654321
4. ✅ Создаётся: user:tg:987654321
5. ✅ С полем: sponsorId = "u_tg_123456789" (Артем!)
```

---

## 📱 ДВА СПОСОБА ВХОДА = ОДИН АККАУНТ:

### Login Widget (сайт):
```
┌──────────────────────────┐
│  [Log in with Telegram]  │  ← Кнопка на сайте
└──────────────────────────┘
            ↓
  Открывается окно Telegram
            ↓
    Подтверждение доступа
            ↓
  Telegram ID → 123456789
            ↓
    user:tg:123456789 ✅
```

### Mini App (Telegram):
```
┌──────────────────────────┐
│  t.me/h2enterbot/h2partner│  ← Ссылка в Telegram
└──────────────────────────┘
            ↓
  Открывается внутри Telegram
            ↓
    Автоматическая передача ID
            ↓
  Telegram ID → 123456789
            ↓
    user:tg:123456789 ✅
```

---

## 🎯 ИТОГ:

### ДО настройки:
- ❌ Два разных аккаунта
- ❌ Разные данные
- ❌ Путаница

### ПОСЛЕ настройки (/setdomain):
- ✅ Один аккаунт
- ✅ Единая база данных
- ✅ Telegram ID = ключ к данным

---

## 💡 ВАЖНО ПОНИМАТЬ:

**Telegram ID** - это как паспорт пользователя:
- 🔐 Уникальный
- 🔒 Неизменный
- 🔑 Ключ к твоим данным

**Неважно** как ты заходишь:
- Через кнопку на сайте
- Через ссылку в Telegram
- Через QR-код
- Через реферальную ссылку

**Telegram ID ВСЕГДА ОДИН!** 

→ **Аккаунт ВСЕГДА ОДИН!** ✅

---

Теперь понятно? 🚀
