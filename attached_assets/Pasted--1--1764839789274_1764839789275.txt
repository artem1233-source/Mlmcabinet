Используй свой предыдущий анализ рангов и выполни план правок.

Цели:

1) Новые пользователи без партнёров ДОЛЖНЫ иметь ранг 0.
   – Пока под пользователем нет ни одного партнёра в структуре, ранг = 0.
   – Как только появляется первая линия, ранг становится 1.
   – При цепочке A → B → C: A = 2, B = 1, C = 0.

2) Не должно быть ошибки "off-by-one":
   – Формула ранга = максимальная глубина структуры ВНИЗ от этого пользователя.
   – Сам пользователь НЕ входит в глубину.
   – Если потомков нет → ранг = 0.

Сделай следующее:

1. В файле src/supabase/functions/server/rank_calculator.tsx:
   – Приведи calculateTreeDepth к той же семантике, что используется в diagnose-ranks:
     • если нет детей → возвращать 0;
     • если дети есть → ранг = maxChildRank + 1;
   – Убедись, что нигде не возникает лишний "+1" сверху.
   – Если сейчас maxDepth инициализируется -1 и потом к нему добавляется 1,
     проверь, что для пользователя без команды итог остаётся 0, а не 1.

2. В местах, где создаётся новый пользователь (index.tsx):
   – Убедись, что при регистрации у него:
       уровень = 0,
       ранг = 0 (если есть отдельное поле),
       команда = [].
   – После регистрации, при вызове updateUplineRanks / аналогичной функции,
     убедись, что ранг самого нового пользователя НЕ поднимается до 1
     только из-за логики аплайна.

3. Работа с кешем ранга:
   – Найди все места, где используется кеш rank:user:{userId}.
   – При регистрации нового пользователя:
       • явно записывай в кеш ранг 0 ИЛИ очищай/не используй кеш, пока ранг не будет
         рассчитан корректно.
   – При изменении структуры (смена аплайна, перенос ветки, удаление пользователя):
       • обновляй ранг у всех затронутых пользователей и синхронизируй кеш.

4. Перерасчёт рангов:
   – Реализуй (или используй уже существующую) функцию, которая
     проходит по всей структуре и пересчитывает ранги для всех пользователей,
     используя обновлённую логику calculateTreeDepth.
   – Добавь удобный способ запустить полный пересчёт (админский endpoint
     или отдельную util-функцию), НО не привязывай его к обычным запросам
     пользователей.

5. Тесты / проверка:
   – Опиши в конце, как вручную проверить следующие сценарии:
       a) Новый пользователь без партнёров → ранг 0.
       b) Пользователь A подписал B (без структуры) → ранг A = 1, B = 0.
       c) A → B → C (цепочка в 2 уровня) → A = 2, B = 1, C = 0.
   – При необходимости добавь простые unit-/integration-тесты или
     хотя бы короткий диагностический скрипт/endpoint для проверки рангов.

В конце:
   – Покажи diff по всем изменённым файлам.
   – Кратко объясни, в чём именно была ошибка off-by-one
     и какая формула ранга используется теперь.