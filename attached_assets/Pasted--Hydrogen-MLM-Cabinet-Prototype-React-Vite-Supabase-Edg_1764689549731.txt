Я работаю над проектом “Hydrogen MLM Cabinet Prototype” (React + Vite фронт, Supabase Edge Functions/KV бекенд, MLM-структура).

Нужно переработать систему партнерских ID, чтобы:
	1.	Смена ID не освобождала старый номер для других пользователей.
	2.	Один пользователь мог иметь несколько ID (цифровых и буквенных).
	3.	В заказах и статистике было видно, по какому именно ID была сделана покупка.

Опиши, что у нас сейчас и что нужно сделать:

ТЕКУЩЕЕ ПОВЕДЕНИЕ (ПРОБЛЕМА):
	1.	У пользователя есть один «номер партнера» (ID), который используется:
– в реферальной ссылке,
– для оформления заказов,
– в расчетах MLM-структуры (к кому уходит комиссия).
	2.	В админке реализован функционал изменения этого ID (есть утилиты вроде IdManager, change-user-id, reserved:id и т.п. — найди по коду).
	3.	При смене ID:
– у пользователя просто меняется его ID,
– старый ID помечается как свободный (reserved/id…)
– этот освободившийся ID затем может быть назначен другому пользователю.
	4.	Из-за этого, если партнер уже раздал свой старый ID клиентам (на визитках, в чате, в постах), а админ поменял ему ID:
– клиенты продолжают покупать по старому ID,
– но деньги получает уже другой партнер, которому этот ID достался,
– это недопустимо с точки зрения безопасности и доверия.

ТРЕБУЕМАЯ НОВАЯ ЛОГИКА:
	1.	ID должен быть НЕПЕРЕХОДЯЩИМ.
– Как только какой-то ID (цифровой или буквенный) был привязан к конкретному userId, он больше никогда не должен присваиваться другому пользователю.
– Смена ID не освобождает старый ID, а добавляет пользователю еще один ID.
	2.	У одного пользователя может быть несколько ID.
– Например: 001, 777, “ARTEM”, “H2PRO” и т.д.
– Должна быть возможность хранить и цифровые, и буквенно-цифровые коды.
– Должно быть понятие «основного» ID (primary), который используется по умолчанию в интерфейсе и при генерации реферальной ссылки, но все остальные ID тоже остаются рабочими.
	3.	При оформлении заказа нужно фиксировать, какой конкретно ID использовался.
– В записи заказа (order) должно быть отдельное поле, например:
– refId / partnerCode / usedId (строка),
– плюс, как и сейчас, ссылка на userId партнера (чтобы не ломать MLM-логику).
– Логика:
– по коду/ID (цифровому или буквенно-цифровому) находится соответствующий userId,
– создается заказ,
– в заказе сохраняется и userId, и сам использованный ID в виде строки.
– В интерфейсе админки и в партнерском кабинете:
– в списке заказов и в блоке «Доходы» добавить колонку «ID» или «Код»,
– чтобы партнер видел, по какому именно своему ID был оформлен каждый заказ.
	4.	UI/админка для работы с ID:
– В карточке пользователя в админке нужно:
– показывать список его ID (цифровых и буквенно-цифровых),
пример структуры: [ { value: “001”, type: “numeric”, primary: true }, { value: “ARTEM”, type: “alpha”, primary: false } ]
– кнопку «Добавить ID» (вместо/в дополнение к текущей “Сменить ID”);
– возможность отметить один из ID как «основной» (primary);
– опционально — возможность деактивировать конкретный ID (isActive = false), но даже деактивированный ID НЕ может быть присвоен другому пользователю (можно использовать флаг активности, но не удалять связь).
– Важно:
– убрать/переделать текущую логику, где старый ID возвращается в пул свободных (reserved:id),
– вместо этого этот ID должен оставаться жестко привязанным к исходному userId.
	5.	Требования к модели данных (предложение, можешь реализовать эквивалентно):
Бэкэнд (Supabase KV):
– Сейчас, судя по описанию, есть ключи вида:
– user:id:{userId} – данные пользователя
– reserved:id:{number} – резервирование числовых ID
– Нужно сделать явное отображение:
– mapping ID → userId,
например ключ id:code:{idString} → { userId, primary: boolean, isActive: boolean, createdAt }
(idString может быть “001” или “ARTEM”).
– В объекте пользователя:
– добавить поле вроде ids или codes: массив структур
[{ value: string; primary: boolean; type: “numeric” | “alphanumeric”; isActive: boolean; createdAt: string }]
– Все проверки уникальности ID должны идти по этому глобальному mapping’у:
– нельзя создать/добавить ID, если уже есть запись id:code:{value} на любого userId.
	6.	Миграция/совместимость:
– Пройтись по существующим пользователям и:
– текущий «основной» ID каждого пользователя перенести в массив ids как единственный элемент с primary = true;
– создать соответствующий ключ id:code:{старыйID} → userId.
– Пул reserved:id и подобные сущности, которые разрешают переиспользование ID, нужно либо отключить, либо модифицировать так, чтобы они не выдавали уже использованные IDs другим пользователям.
	7.	Важно, что нужно сохранить:
– Не трогать логику расчета комиссий и MLM-дерева:
– как только по коду найден userId, дальше вся существующая система комиссий, спонсоров и структуры должна работать как раньше.
– Меняется только:
– хранение и управление самими ID/кодами,
– то, как они резолвятся в userId,
– и отображение ID в заказах/отчетах.

ЗАДАНИЕ ДЛЯ ТЕБЯ (Replit Agent):
	1.	Найди текущую реализацию:
– change-user-id / IdManager / reserved id logic,
– обработку реферальных ссылок / полей ID в заказах,
– UI для редактирования ID в админке.
	2.	Спроектируй и реализуй поддержку:
– множественных ID на одного пользователя,
– глобального mapping ID → userId,
– запрета повторного использования ID другими пользователями,
– сохранения использованного ID в заказах.
	3.	Обнови фронтенд:
– карточка пользователя в админке,
– список заказов/доходов (добавить колонку/фильтр по ID).
	4.	После изменений:
– дай краткое описание новой модели данных для user и order,
– опиши, как теперь работает сценарий:
«у пользователя был ID 001, админ добавил ему новый ID 777; клиенты продолжают покупать и по 001, и по 777; все покупки и комиссии уходят одному и тому же userId, но в отчетах видно, по какому ID пришел заказ».

Сделай все правки аккуратно, без ломки существующей логики MLM, и прокомментируй ключевые участки кода.